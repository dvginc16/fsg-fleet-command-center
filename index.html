<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FSG Fleet Command Center v2.0</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        :root {
            --bg: #0a0f1e;
            --bg2: #0f1629;
            --bg3: #141b2f;
            --bg4: #1a2240;
            --gold: #f0b429;
            --gold2: #d4a017;
            --white: #f0f0f0;
            --muted: #8899aa;
            --green: #22c55e;
            --red: #ef4444;
            --blue: #3b82f6;
            --cyan: #06b6d4;
            --border: rgba(240,180,41,0.15);
            --card-bg: #101828;
            --radius: 10px;
        }
        body { 
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; 
            background: var(--bg); 
            color: var(--white); 
            min-height: 100vh; 
            display: flex;
            flex-direction: column;
        }
        
        /* Auth Overlay */
        #auth-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .auth-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            padding: 40px;
            border-radius: var(--radius);
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .auth-card h2 { color: var(--gold); margin-bottom: 24px; }
        .auth-card input {
            width: 100%;
            padding: 12px;
            margin-bottom: 16px;
            background: var(--bg3);
            border: 1px solid var(--border);
            color: white;
            border-radius: 6px;
            outline: none;
            text-align: center;
            font-size: 1.1rem;
        }
        .auth-card button {
            background: var(--gold);
            color: var(--bg);
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            transition: opacity 0.2s;
        }
        .auth-card button:hover { opacity: 0.9; }
        #auth-error { color: var(--red); font-size: 0.85rem; margin-top: 12px; display: none; }

        /* Main App Hidden Initially */
        #app-content { display: none; }

        .header { background: linear-gradient(135deg, #0a0f1e 0%, #141b2f 100%); border-bottom: 1px solid var(--border); padding: 16px 24px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px; }
        .header-title { display: flex; align-items: center; gap: 12px; }
        .header-title h1 { font-size: 1.4rem; color: var(--gold); letter-spacing: 0.5px; }
        .header-title .version { font-size: 0.75rem; background: var(--gold); color: var(--bg); padding: 2px 8px; border-radius: 12px; font-weight: 700; }
        .header-meta { font-size: 0.8rem; color: var(--muted); }
        .tab-bar { display: flex; background: var(--bg2); border-bottom: 2px solid var(--border); overflow-x: auto; position: sticky; top: 0; z-index: 100; }
        .tab-btn { background: none; border: none; color: var(--muted); padding: 12px 20px; font-size: 0.85rem; cursor: pointer; white-space: nowrap; border-bottom: 2px solid transparent; transition: all 0.2s; font-weight: 500; }
        .tab-btn:hover { color: var(--white); background: rgba(240,180,41,0.05); }
        .tab-btn.active { color: var(--gold); border-bottom-color: var(--gold); background: rgba(240,180,41,0.08); }
        .tab-content { display: none; padding: 24px; max-width: 1400px; margin: 0 auto; width: 100%; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card { background: var(--card-bg); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 16px; position: relative; }
        .card h3 { color: var(--gold); margin-bottom: 12px; font-size: 1rem; }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .kpi-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; text-align: center; transition: transform 0.2s; }
        .kpi-card:hover { transform: translateY(-2px); }
        .kpi-card .label { font-size: 0.75rem; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
        .kpi-card .value { font-size: 1.8rem; font-weight: 700; color: var(--gold); }
        .chart-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px; }
        .chart-container { position: relative; height: 320px; width: 100%; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .data-table th { background: var(--bg3); color: var(--gold); padding: 10px 12px; text-align: left; border-bottom: 2px solid var(--border); }
        .data-table td { padding: 8px 12px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .filter-group { display: flex; gap: 16px; margin-bottom: 20px; align-items: center; background: var(--bg3); padding: 12px 20px; border-radius: var(--radius); border: 1px solid var(--border); }
        .filter-item { display: flex; flex-direction: column; gap: 4px; }
        .filter-item label { font-size: 0.75rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }
        .filter-item select { background: var(--bg4); border: 1px solid var(--border); color: var(--white); padding: 6px 12px; border-radius: 6px; font-size: 0.85rem; outline: none; }
        .filter-item select:focus { border-color: var(--gold); }
        .slider-group { margin-bottom: 12px; }
        .slider-group label { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--muted); }
        .slider-group label span { color: var(--gold); font-weight: 600; }
        .slider-group input[type="range"] { width: 100%; accent-color: var(--gold); margin-top: 4px; }
        .badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; font-weight: 600; }
        .badge-red { background: rgba(239,68,68,0.2); color: #ef4444; }
        .badge-green { background: rgba(34,197,94,0.2); color: #22c55e; }
        .audit-row { padding: 12px 0; border-bottom: 1px solid var(--border); }
        .audit-row:last-child { border-bottom: none; }
        .audit-label { font-size: 0.75rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 4px; }
        .audit-value { font-size: 0.95rem; color: var(--white); }
        .audit-formula { font-size: 0.8rem; color: var(--cyan); font-family: monospace; margin-top: 2px; }
        .alert { padding: 12px; border-radius: var(--radius); margin-bottom: 16px; border-left: 4px solid; }
        .alert-danger { background: rgba(239,68,68,0.1); border-left-color: var(--red); }
        .footnote { font-size: 0.75rem; color: var(--muted); margin-top: 8px; }
        @media (max-width: 768px) { .chart-row { grid-template-columns: 1fr; } .filter-group { flex-direction: column; align-items: stretch; } }
        .brand-footer { text-align: center; padding: 24px; color: var(--muted); font-size: 0.8rem; border-top: 1px solid var(--border); margin-top: 40px; }
    </style>
</head>
<body>

    <!-- Simple Password Gate -->
    <div id="auth-overlay">
        <div class="auth-card">
            <h2>Access Required</h2>
            <input type="password" id="pass-field" placeholder="Enter Password" onkeypress="handleKey(event)">
            <button onclick="checkPass()">Unlock Dashboard</button>
            <div id="auth-error">Incorrect password. Please try again.</div>
        </div>
    </div>

    <div id="app-content">
        <header class="header">
            <div class="header-title">
                <h1>FSG Fleet Command Center</h1>
                <span class="version">v2.0</span>
            </div>
            <div class="header-meta"> Prepared by <strong>Incasu (Pty) Ltd</strong> • Actuarial Services </div>
        </header>
        <div class="tab-bar">
            <button class="tab-btn active" data-tab="overview">Overview</button>
            <button class="tab-btn" data-tab="actuarial">Actuarial Calculations</button>
            <button class="tab-btn" data-tab="bombing">Special Perils — Bombing</button>
            <button class="tab-btn" data-tab="quote">Quote Engine</button>
            <button class="tab-btn" data-tab="deepdive">Deep Dive Analytics</button>
            <button class="tab-btn" data-tab="audit">Methodology / Audit Trail</button>
        </div>
        
        <div id="tab-overview" class="tab-content active">
            <!-- Content same as before -->
            <div class="filter-group">
                <div class="filter-item">
                    <label>Year Filter</label>
                    <select id="overview-year-filter" onchange="updateOverview()">
                        <option value="all">All Years (2021-24)</option>
                        <option value="2021">2021</option>
                        <option value="2022">2022</option>
                        <option value="2023">2023</option>
                        <option value="2024">2024</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>Regional Filter</label>
                    <select id="overview-region-filter" onchange="updateOverview()">
                        <option value="all">All Regions</option>
                        <option value="Gauteng">Gauteng</option>
                        <option value="KZN">KZN</option>
                        <option value="Western Cape">Western Cape</option>
                        <option value="Eastern Cape">Eastern Cape</option>
                        <option value="Limpopo">Limpopo</option>
                        <option value="Mpumalanga">Mpumalanga</option>
                    </select>
                </div>
            </div>
            <div class="kpi-grid">
                <div class="kpi-card"><div class="label">Total Incidents</div><div id="ov-incidents" class="value">10,189</div><div id="ov-incidents-sub" class="footnote">Excl. bombing (105 incidents)</div></div>
                <div class="kpi-card"><div class="label">Fleet Size (Avg)</div><div id="ov-fleet" class="value">6,061</div><div id="ov-fleet-sub" class="footnote">vehicles | 24,244 veh-years</div></div>
                <div class="kpi-card"><div class="label">Annual Frequency (λ)</div><div id="ov-lambda" class="value">10.51%</div><div class="footnote">per vehicle-year</div></div>
                <div class="kpi-card"><div class="label">Raw Avg Severity (μ)</div><div id="ov-severity" class="value">R215,289</div><div class="footnote">S ÷ N (all claims ÷ incidents)</div></div>
                <div class="kpi-card"><div class="label">Pure Premium (PP)</div><div id="ov-pp" class="value">R9,506</div><div class="footnote">λ × μ (demo cap applied)</div></div>
                <div class="kpi-card"><div class="label">Technical Premium (TP)</div><div id="ov-tp" class="value">R11,217</div><div class="footnote">PP × (1 + 18% loading)</div></div>
            </div>
            <div class="chart-row">
                <div class="card"><h3>Annual Incident Trend</h3><div class="chart-container"><canvas id="trendChart"></canvas></div></div>
                <div class="card"><h3>Regional Distribution</h3><div class="chart-container"><canvas id="regionChart"></canvas></div></div>
            </div>
            <div class="card">
                <h3>SSOT Data Constants</h3>
                <table class="data-table">
                    <thead><tr><th>Parameter</th><th>Value</th><th>Source</th></tr></thead>
                    <tbody id="overview-table-body">
                        <tr><td>Fleet size (n)</td><td>6,061 vehicles</td><td>SSOT verified</td></tr>
                        <tr><td>Observation years (T)</td><td>4 years (2021–2024)</td><td>SSOT verified</td></tr>
                        <tr><td>Exposure (E = n × T)</td><td>24,244 vehicle-years</td><td>Calculated</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="tab-actuarial" class="tab-content">
            <div class="card">
                <h3>Step-by-Step Actuarial Derivation</h3>
                <table class="data-table">
                    <thead><tr><th>Step</th><th>Formula</th><th>Inputs</th><th>Result</th></tr></thead>
                    <tbody>
                        <tr><td>1. Exposure</td><td>E = n × T</td><td>n=6,061 × T=4</td><td>24,244 vy</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="chart-row">
                <div class="card"><h3>Frequency by Year</h3><div class="chart-container"><canvas id="freqChart"></canvas></div></div>
                <div class="card"><h3>Premium Waterfall</h3><div class="chart-container"><canvas id="waterfallChart"></canvas></div></div>
            </div>
        </div>

        <div id="tab-bombing" class="tab-content">
            <div class="alert alert-danger"><strong>Special Peril — Vehicle Bombing Excluded</strong></div>
            <div class="kpi-grid">
                <div class="kpi-card"><div class="label">Incidents</div><div class="value">105</div></div>
                <div class="kpi-card"><div class="label">Cost</div><div class="value">R83.6m</div></div>
            </div>
        </div>

        <div id="tab-quote" class="tab-content">
            <div class="card">
                <h3>Interactive Quote Engine</h3>
                <div class="slider-group"><label>Fleet Size: <span id="v-fleet">6,061</span></label><input type="range" id="s-fleet" min="1000" max="20000" value="6061" oninput="calcQuote()"></div>
                <div id="res-prem" class="value" style="font-size: 2.8rem; color: var(--gold); text-align: center; margin-top: 20px;">R67,987,172</div>
            </div>
        </div>

        <div id="tab-deepdive" class="tab-content">
            <div class="chart-row">
                <div class="card"><h3>Incident Trend</h3><div class="chart-container"><canvas id="trendDeepChart"></canvas></div></div>
                <div class="card"><h3>Peril Split</h3><div class="chart-container"><canvas id="perilChart"></canvas></div></div>
            </div>
            <div class="card"><h3>Regional Heat Map</h3><canvas id="heatmapChart" height="140"></canvas></div>
        </div>

        <div id="tab-audit" class="tab-content">
            <div class="card"><h3>Methodology</h3><div class="audit-row"><div class="audit-label">Exposure</div><div class="audit-value">6,061 x 4 = 24,244 vy</div></div></div>
        </div>

        <footer class="brand-footer"> FSG Fleet Command Center v2.0 • February 2026 </footer>
    </div>

    <script>
        // AUTH LOGIC
        function handleKey(e) { if(e.keyCode === 13) checkPass(); }
        function checkPass() {
            const pass = document.getElementById('pass-field').value;
            if(pass === 'ccic123') {
                document.getElementById('auth-overlay').style.display = 'none';
                document.getElementById('app-content').style.display = 'block';
                // Initialize charts only after unlock
                initCharts();
                calcQuote();
            } else {
                document.getElementById('auth-error').style.display = 'block';
                document.getElementById('pass-field').value = '';
            }
        }

        const SSOT = { fleetSize: 6061, years: 4, exposure: 24244, lambdaAnnual: 0.1051, severityMu: 90476, loading: 0.18 };
        const REGION_DATA = [ {name:'Gauteng', incidents:3200, cost: 688924800}, {name:'KZN', incidents:2100, cost: 452106900}, {name:'Western Cape', incidents:1800, cost: 387520000}, {name:'Eastern Cape', incidents:900, cost: 193760000}, {name:'Limpopo', incidents:750, cost: 161460000}, {name:'Mpumalanga', incidents:600, cost: 129160000}, {name:'Free State', incidents:539, cost: 180616687} ];
        const YEARLY_DATA = { '2021': {incidents: 2024, cost: 435745120}, '2022': {incidents: 2532, cost: 545112100}, '2023': {incidents: 3197, cost: 688280000}, '2024': {incidents: 2436, cost: 524411167} };
        
        const RAW_DATA = [];
        ['2021', '2022', '2023', '2024'].forEach(y => {
            ['Gauteng', 'KZN', 'Western Cape', 'Eastern Cape', 'Limpopo', 'Mpumalanga', 'Free State'].forEach(r => {
                const baseInc = Math.floor(YEARLY_DATA[y].incidents / 7);
                const baseCost = YEARLY_DATA[y].cost / 7;
                RAW_DATA.push({ year: y, region: r, incidents: baseInc + (r === 'Gauteng' ? 100 : -10), cost: baseCost });
            });
        });

        let charts = {};

        function updateOverview() {
            const year = document.getElementById('overview-year-filter').value;
            const region = document.getElementById('overview-region-filter').value;
            let filtered = RAW_DATA;
            if(year !== 'all') filtered = filtered.filter(d => d.year === year);
            if(region !== 'all') filtered = filtered.filter(d => d.region === region);
            const totalInc = filtered.reduce((sum, d) => sum + d.incidents, 0);
            const totalCost = filtered.reduce((sum, d) => sum + d.cost, 0);
            const effectiveYears = year === 'all' ? 4 : 1;
            const exposure = SSOT.fleetSize * effectiveYears;
            const lambda = totalInc / exposure;
            const pp = lambda * SSOT.severityMu;
            const tp = pp * (1 + SSOT.loading);
            document.getElementById('ov-incidents').textContent = totalInc.toLocaleString();
            document.getElementById('ov-lambda').textContent = (lambda * 100).toFixed(2) + '%';
            document.getElementById('ov-pp').textContent = 'R' + Math.round(pp).toLocaleString('en-ZA');
            document.getElementById('ov-tp').textContent = 'R' + Math.round(tp).toLocaleString('en-ZA');
            if(charts.trend) {
                charts.trend.data.datasets[0].data = ['2021', '2022', '2023', '2024'].map(y => filtered.filter(d => d.year === y).reduce((s, d) => s + d.incidents, 0));
                charts.trend.update();
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
            if(tabName === 'deepdive' && window.drawHeatmap) window.drawHeatmap();
        }

        function calcQuote() {
            const fleet = parseFloat(document.getElementById('s-fleet').value);
            document.getElementById('v-fleet').textContent = fleet.toLocaleString();
            const tp = (SSOT.lambdaAnnual * SSOT.severityMu) * (1 + SSOT.loading);
            document.getElementById('res-prem').textContent = 'R' + Math.round(tp * fleet).toLocaleString('en-ZA');
        }

        function initCharts() {
            if(charts.trend) return;
            charts.trend = new Chart(document.getElementById('trendChart'), { type: 'bar', data: { labels: ['2021', '2022', '2023', '2024'], datasets: [{ label: 'Incidents', data: [2024, 2532, 3197, 2436], backgroundColor: '#f0b429' }] }, options: { responsive: true, maintainAspectRatio: false } });
            charts.region = new Chart(document.getElementById('regionChart'), { type: 'doughnut', data: { labels: ['Gauteng', 'KZN', 'WC', 'EC', 'LIM', 'MP', 'FS'], datasets: [{ data: [3200, 2100, 1800, 900, 750, 600, 539], backgroundColor: ['#f0b429', '#ef4444', '#3b82f6', '#22c55e', '#8899aa', '#06b6d4', '#d4a017'] }] }, options: { responsive: true, maintainAspectRatio: false } });
            new Chart(document.getElementById('freqChart'), { type: 'line', data: { labels: ['2021', '2022', '2023', '2024'], datasets: [{ label: 'λ', data: [0.0334, 0.0418, 0.0527, 0.0402], borderColor: '#06b6d4', fill: true }] } });
            new Chart(document.getElementById('waterfallChart'), { type: 'bar', data: { labels: ['Pure', 'IBNR', 'Profit', 'Tech'], datasets: [{ data: [9506, 951, 760, 11217], backgroundColor: '#f0b429' }] } });
            new Chart(document.getElementById('perilChart'), { type: 'pie', data: { labels: ['Collision', 'Theft', 'Third Party', 'Other'], datasets: [{ data: [45, 22, 18, 15], backgroundColor: ['#f0b429', '#ef4444', '#3b82f6', '#8899aa'] }] } });
            new Chart(document.getElementById('trendDeepChart'), { type: 'line', data: { labels: ['2021', '2022', '2023', '2024'], datasets: [{ label: 'Actual', data: [2024, 2532, 3197, 2436], borderColor: '#f0b429' }] } });
            window.drawHeatmap = function() {
                const ctx = document.getElementById('heatmapChart').getContext('2d');
                ctx.fillStyle = '#f0b429'; ctx.fillRect(10, 10, 100, 100); // Placeholder
            };
        }

        document.querySelectorAll('.tab-btn').forEach(btn => btn.addEventListener('click', () => switchTab(btn.dataset.tab)));
    </script>
</body>
</html>
